<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Income Tax Calculator (AY 2024-25) | Pro</title>
    <meta name="description" content="Comprehensive Indian Income Tax Calculator for AY 2024-25. Calculate tax under Old and New Regimes, explore deductions, get optimization tips, visualize results, and download a PDF report. Features dual themes and professional animations.">
    <meta name="keywords" content="income tax calculator, india, ay 2024-25, fy 2023-24, old regime, new regime, tax calculation, deductions, 80c, 80d, hra, tax saving, tax optimization, pdf report, dark theme, finance, tool">

    <!-- Favicon (Simple Emoji) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Libraries via CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>


    <style>
        /* ============================== */
        /* == CSS (Themes, Layout, Anim) == */
        /* ============================== */

        /* CSS Reset and Base Styles */
        :root {
            /* Light Theme Variables */
            --bg-color-light: #f8f9fa;
            --text-color-light: #212529;
            --primary-color-light: #007bff;
            --secondary-color-light: #6c757d;
            --card-bg-light: #ffffff;
            --border-color-light: #dee2e6;
            --input-bg-light: #ffffff;
            --input-border-light: #ced4da;
            --success-color-light: #28a745;
            --error-color-light: #dc3545;
            --info-color-light: #17a2b8;
            --warning-color-light: #ffc107;
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.08);
            --highlight-bg-light: #e9ecef;
            /* RGB versions for RGBA compatibility in box-shadows etc. */
            --primary-color-rgb-light: 0, 123, 255;
            --error-color-rgb-light: 220, 53, 69;
            --success-color-rgb-light: 40, 167, 69;
             --info-color-rgb-light: 23, 162, 184;

            /* Dark Theme Variables */
            --bg-color-dark: #1a1a1a;
            --text-color-dark: #e8e8e8; /* Slightly lighter grey */
            --primary-color-dark: #4dabf7; /* Brighter blue */
            --secondary-color-dark: #adb5bd;
            --card-bg-dark: #2c2c2c;
            --border-color-dark: #4a4a4a; /* Darker border */
            --input-bg-dark: #333;
            --input-border-dark: #555;
            --success-color-dark: #20c997; /* Tealish green */
            --error-color-dark: #f76e79; /* Lighter red */
            --info-color-dark: #3bc9db; /* Lighter cyan */
             --warning-color-dark: #ffd43b; /* Brighter yellow */
            --shadow-dark: 0 5px 20px rgba(0, 0, 0, 0.3);
            --highlight-bg-dark: #3a3a3a;
            /* RGB versions for dark */
             --primary-color-rgb-dark: 77, 171, 247;
             --error-color-rgb-dark: 247, 110, 121;
             --success-color-rgb-dark: 32, 201, 151;
            --info-color-rgb-dark: 59, 201, 219;

            /* Applied Variables (Default to Light) */
            --bg-color: var(--bg-color-light);
            --text-color: var(--text-color-light);
            --primary-color: var(--primary-color-light);
            --secondary-color: var(--secondary-color-light);
            --card-bg: var(--card-bg-light);
            --border-color: var(--border-color-light);
            --input-bg: var(--input-bg-light);
            --input-border: var(--input-border-light);
            --success-color: var(--success-color-light);
            --error-color: var(--error-color-light);
            --info-color: var(--info-color-light);
            --warning-color: var(--warning-color-light);
            --shadow: var(--shadow-light);
            --highlight-bg: var(--highlight-bg-light);
            --primary-color-rgb: var(--primary-color-rgb-light);
            --error-color-rgb: var(--error-color-rgb-light);
             --success-color-rgb: var(--success-color-rgb-light);
            --info-color-rgb: var(--info-color-rgb-light);

            --font-family: 'Poppins', sans-serif;
            --transition-speed: 0.3s;
            --animation-ease: cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .dark-mode {
            --bg-color: var(--bg-color-dark);
            --text-color: var(--text-color-dark);
            --primary-color: var(--primary-color-dark);
            --secondary-color: var(--secondary-color-dark);
            --card-bg: var(--card-bg-dark);
            --border-color: var(--border-color-dark);
            --input-bg: var(--input-bg-dark);
            --input-border: var(--input-border-dark);
            --success-color: var(--success-color-dark);
            --error-color: var(--error-color-dark);
            --info-color: var(--info-color-dark);
             --warning-color: var(--warning-color-dark);
            --shadow: var(--shadow-dark);
            --highlight-bg: var(--highlight-bg-dark);
            --primary-color-rgb: var(--primary-color-rgb-dark);
             --error-color-rgb: var(--error-color-rgb-dark);
            --success-color-rgb: var(--success-color-rgb-dark);
             --info-color-rgb: var(--info-color-rgb-dark);
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
            font-size: 16px; /* Base font size */
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            overflow-x: hidden; /* Prevent horizontal scroll */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            width: 90%;
            max-width: 1280px; /* Slightly wider for larger screens */
            margin: 2rem auto;
            padding: 1.5rem;
            flex-grow: 1;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2.5rem; /* Increased margin */
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            opacity: 0;
            transform: translateY(-20px);
            transition: border-color var(--transition-speed) ease;
        }

        header h1 {
            font-size: clamp(1.5rem, 4vw, 2rem); /* Responsive font size */
            font-weight: 700; /* Bolder */
            color: var(--primary-color);
            transition: color var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        header h1 .fa-calculator {
            font-size: 0.9em;
        }
        header h1 small {
            font-size: 0.5em;
            color: var(--secondary-color);
            font-weight: 400;
            margin-left: 5px;
             transition: color var(--transition-speed) ease;
        }

        /* Theme Toggle */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
        }
        .theme-switch {
            display: inline-block;
            height: 30px; /* Slightly larger */
            position: relative;
            width: 60px; /* Slightly wider */
            margin-left: 12px;
        }
        .theme-switch input { display:none; }
        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s var(--animation-ease);
            border-radius: 30px;
        }
        .slider:before { /* The switch handle */
            background-color: #fff;
            bottom: 4px;
            content: "";
            height: 22px;
            left: 4px;
            position: absolute;
            transition: .4s var(--animation-ease);
            width: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #777; /* Default icon color */
        }
        /* Icons inside the slider */
         .slider::after { /* Icon shown when UNCHECKED (light mode) */
             content: '‚òÄÔ∏è';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
             font-size: 14px;
             color: #f0ad4e;
             opacity: 1;
             transition: opacity 0.4s ease;
             z-index: 0;
         }
        .dark-mode .slider::after { opacity: 0; }

        /* Position Moon icon inside handle */
        input:checked + .slider:before {
             content: 'üåô';
             transform: translateX(30px); /* Moves handle to the right */
             color: var(--primary-color-dark); /* Icon color in dark */
             background-color: transparent; /* Handle bg not needed with icon */
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }
         .dark-mode .slider:before { /* Handle appearance in dark mode (unchecked) */
            background-color: #ddd; /* Light handle on dark track */
             color: #555;
        }
        .dark-mode input:checked + .slider:before { /* Moon handle in dark mode (checked) */
            color: var(--primary-color-dark); /* Adjust color */
             background-color: #e0e0e0; /* Slightly diff handle background for contrast */
        }


        .theme-switch-wrapper span {
            font-size: 0.9rem;
            margin-right: 8px;
            color: var(--secondary-color);
            transition: color var(--transition-speed) ease;
        }

        /* Main Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr; /* Default to single column */
            gap: 2rem;
        }
        /* Create two columns for wider screens */
        @media (min-width: 992px) {
            .main-grid {
                 /* Left column slightly larger */
                grid-template-columns: 1.2fr 1fr;
             }
        }

        /* Cards */
        .card {
            background-color: var(--card-bg);
            border-radius: 12px; /* Smoother corners */
            padding: clamp(1rem, 5vw, 1.8rem); /* Responsive padding */
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed) ease,
                        border-color var(--transition-speed) ease,
                        box-shadow var(--transition-speed) ease;
            opacity: 0;
            transform: scale(0.95);
        }

        .card h2 {
            font-size: clamp(1.2rem, 4vw, 1.4rem);
            margin-bottom: 1.8rem; /* More spacing */
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.8rem;
            transition: color var(--transition-speed) ease, border-color var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
         .card h2 .fas {
             font-size: 0.9em;
             opacity: 0.8;
         }
        #results-section h2 .fa-chart-line {
            color: var(--success-color);
         }


        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem; /* Increased spacing */
            opacity: 0;
            transform: translateX(-15px);
            position: relative; /* For error message positioning */
        }

        .form-group label {
            display: flex; /* Use flex for alignment */
            align-items: center;
            gap: 6px;
            margin-bottom: 0.6rem; /* Increased spacing */
            font-weight: 500;
            font-size: 0.98rem;
        }
        .form-group label .fa-info-circle {
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.9em;
            transition: color 0.2s ease;
        }
         .form-group label .fa-info-circle:hover {
            color: var(--primary-color);
        }

        /* Tooltip Styles (Simple CSS Tooltip) */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]::after {
             content: attr(data-tooltip);
             position: absolute;
            left: 50%;
             transform: translateX(-50%) translateY(-5px); /* Start slightly offset for transition */
            bottom: 130%; /* Position above */
            background-color: #333;
            color: #fff;
             padding: 6px 12px; /* Better padding */
             border-radius: 5px;
            font-size: 0.88rem;
             line-height: 1.4; /* Ensure readability */
             font-weight: 400; /* Lighter weight */
             white-space: nowrap;
             opacity: 0;
             visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
            z-index: 100; /* Ensure on top */
             pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
         /* Tooltip Arrow */
        [data-tooltip]::before {
             content: "";
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
             bottom: 130%;
            margin-bottom: -5px;
             border-width: 5px;
             border-style: solid;
            border-color: #333 transparent transparent transparent;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 100;
             pointer-events: none;
        }
        [data-tooltip]:hover::after,
        [data-tooltip]:hover::before {
             opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0); /* Move into final position */
        }
         /* Dark mode tooltips */
        .dark-mode [data-tooltip]::after { background-color: #eee; color: #333; }
         .dark-mode [data-tooltip]::before { border-top-color: #eee; }

        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 0.8rem 1rem; /* Comfortable padding */
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text-color);
            border-radius: 6px;
            font-size: 1rem;
            font-family: var(--font-family);
            transition: border-color var(--transition-speed) ease,
                        background-color var(--transition-speed) ease,
                        color var(--transition-speed) ease,
                        box-shadow 0.2s ease;
        }
        .form-group input[type="number"]:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
             box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.2); /* Subtle focus ring */
        }
         /* Style for disabled inputs */
        .form-group input:disabled, .form-group select:disabled {
            background-color: var(--highlight-bg);
             opacity: 0.7;
             cursor: not-allowed;
             border-color: var(--border-color); /* Ensure consistent border */
        }


        /* Input error state */
        .form-group input.error-input, .form-group select.error-input {
             border-color: var(--error-color) !important; /* Ensure override */
        }
         .form-group input.error-input:focus, .form-group select.error-input:focus {
             box-shadow: 0 0 0 3px rgba(var(--error-color-rgb), 0.25) !important;
         }

        .error-message {
             color: var(--error-color);
            font-size: 0.85rem;
             margin-top: 0.4rem;
             min-height: 1.2em; /* Reserve space */
             opacity: 0;
             transition: opacity var(--transition-speed) ease;
             position: absolute; /* Position below input */
             bottom: -1.4em; /* Adjust as needed */
             left: 0;
        }
        .error-message.visible { opacity: 1; }


        /* Regime Toggle */
        .regime-toggle-wrapper { margin-bottom: 2rem; }
        .regime-toggle {
            display: flex;
            background-color: var(--highlight-bg);
            border-radius: 30px;
            padding: 6px;
            position: relative;
            border: 1px solid var(--border-color);
            opacity: 0;
            transform: translateY(10px);
            transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease;
        }
        .regime-toggle label {
             flex: 1;
            text-align: center;
             padding: 0.7rem 1.2rem; /* Better padding */
             cursor: pointer;
             z-index: 1;
            position: relative;
            font-weight: 500;
            font-size: 0.95rem;
             transition: color 0.4s ease;
            margin-bottom: 0; /* Override general label style */
             border-radius: 25px; /* Individual label radius for hover effect */
        }
        .regime-toggle input[type="radio"] { display: none; }
        .regime-slider {
            position: absolute;
            top: 6px; /* Match padding */
             bottom: 6px;
             width: calc(50% - 6px); /* Match padding */
             background-color: var(--primary-color);
            border-radius: 25px;
             transition: transform 0.45s cubic-bezier(0.68, -0.55, 0.27, 1.55), background-color var(--transition-speed) ease; /* Bounce + Color */
            z-index: 0;
             left: 6px;
         }
         #regime-new:checked ~ .regime-slider { transform: translateX(0%); }
        #regime-old:checked ~ .regime-slider { transform: translateX(calc(100% + 0px)); } /* Adjusted slightly if needed */

        /* Text color changes on check */
         #regime-new:checked ~ label[for="regime-new"],
        #regime-old:checked ~ label[for="regime-old"] {
            color: white;
            font-weight: 600;
        }
        /* Hover effect on non-selected label */
        #regime-new:not(:checked) ~ label[for="regime-new"]:hover,
        #regime-old:not(:checked) ~ label[for="regime-old"]:hover {
             background-color: rgba(var(--primary-color-rgb), 0.1); /* Subtle background hover */
         }

        /* Deductions Section */
        #deductions-section {
            margin-top: 2rem;
             padding-top: 1.5rem;
             border-top: 1px dashed var(--border-color);
            transition: border-color var(--transition-speed) ease;
        }
         #deductions-section h3 {
             font-size: 1.2rem;
             margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
         }
         #deduction-regime-note {
             font-size: 0.8em;
            color: var(--secondary-color);
            font-weight: 400;
            margin-left: auto; /* Push note to the right */
            transition: color var(--transition-speed) ease;
         }


         /* HRA Specifics */
         #fg-hra { transition: opacity 0.4s ease, max-height 0.4s ease; overflow: hidden; }
         .hra-inputs {
             max-height: 0;
            overflow: hidden;
            transition: max-height 0.6s ease-in-out, opacity 0.5s ease, margin-top 0.5s ease, padding 0.5s ease;
             opacity: 0;
             margin-top: 0;
             padding-left: 1.2rem;
             margin-left: -1.2rem; /* Pull back to align with other inputs visually */
             border-left: 3px solid var(--info-color);
             background-color: rgba(var(--info-color-rgb), 0.05);
             border-radius: 0 8px 8px 0;
             padding-top: 0;
             padding-bottom: 0;
         }
        .hra-inputs.visible {
            max-height: 600px; /* Ample height */
             opacity: 1;
             margin-top: 1rem;
            padding-top: 1rem;
             padding-bottom: 0.5rem;
         }
         .hra-inputs > p {
            font-size: 1rem;
            font-weight: 600;
             margin-bottom: 1rem;
             color: var(--info-color);
         }


        /* Results Section */
        #results-output { margin-top: 1rem; }
        #initial-message {
            padding: 2rem 1rem;
            text-align: center;
            color: var(--secondary-color);
            font-size: 1.1rem;
             border: 2px dashed var(--border-color);
             border-radius: 8px;
            background-color: var(--highlight-bg);
             transition: all var(--transition-speed) ease;
        }
        .results-summary {
             display: grid;
             /* Responsive grid: 1 column on small, 2 on medium+ */
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
             gap: 1.2rem;
            margin-bottom: 2rem;
             opacity: 0;
             transform: translateY(10px);
        }
        .summary-item {
             background-color: var(--highlight-bg);
             padding: 1.2rem;
             border-radius: 8px;
             border-left: 5px solid var(--primary-color);
             transition: all var(--transition-speed) ease;
             opacity: 0;
             transform: scale(0.9);
            position: relative;
            overflow: hidden;
         }
        .summary-item:hover {
             transform: translateY(-3px) scale(1.01); /* Subtle hover lift */
             box-shadow: 0 6px 12px rgba(0,0,0,0.1);
         }
        .dark-mode .summary-item:hover { box-shadow: 0 6px 12px rgba(0,0,0,0.25); }

         /* Color coding borders */
        .summary-item.taxable-income-item { border-color: var(--warning-color); }
         .summary-item.tax-payable-item { border-color: var(--error-color); }
         .summary-item.take-home-item { border-color: var(--success-color); }

        .summary-item p {
             font-size: 0.9rem;
             color: var(--secondary-color);
             margin-bottom: 0.4rem;
             transition: color var(--transition-speed) ease;
             font-weight: 500;
         }
        .summary-item span {
             font-size: clamp(1.3rem, 4vw, 1.6rem); /* Responsive font size */
            font-weight: 700; /* Bolder values */
            display: block;
            color: var(--text-color);
            transition: color var(--transition-speed) ease;
         }
         .result-value { display: inline-block; } /* For GSAP counter target */


         /* Breakdown Table */
        .breakdown-container h3 {
             font-size: 1.2rem;
            margin-bottom: 1rem;
             padding-top: 1.5rem;
             border-top: 1px dashed var(--border-color);
         }
        .breakdown-table {
             width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
         }
        .breakdown-table th, .breakdown-table td {
            text-align: left;
            padding: 0.8rem 0.6rem;
             border-bottom: 1px solid var(--border-color);
             font-size: 0.95rem;
             transition: all var(--transition-speed) ease;
            opacity: 0;
            transform: translateX(-10px);
         }
        .breakdown-table th {
            font-weight: 500; /* Slightly less bold headers */
             color: var(--secondary-color);
             width: 65%; /* Give more space to description */
         }
        .breakdown-table tr:last-child th,
        .breakdown-table tr:last-child td { border-bottom: none; }

        .breakdown-table td:last-child {
            font-weight: 600; /* Bold values */
            text-align: right;
             color: var(--text-color); /* Ensure contrast */
        }
        /* Highlight key rows */
        .breakdown-table tr.highlight-row th,
         .breakdown-table tr.highlight-row td {
             font-weight: 600;
            background-color: var(--highlight-bg);
        }
         .breakdown-table tr.total-tax-row td {
             color: var(--error-color); /* Highlight final tax */
             font-size: 1.05em; /* Make slightly larger */
         }

        /* Comparison Note & Suggestions */
        .comparison-note, .optimization-suggestions {
            margin-top: 1.8rem;
            padding: 1.2rem;
            background-color: var(--highlight-bg);
            border-radius: 8px;
            border-left: 4px solid var(--info-color);
            transition: all var(--transition-speed) ease;
            opacity: 0;
            transform: scale(0.95);
         }
        .optimization-suggestions { border-color: var(--warning-color); }

        .comparison-note h3, .optimization-suggestions h3 {
            font-size: 1.15rem;
            margin-bottom: 0.8rem;
            font-weight: 600;
             display: flex;
             align-items: center;
            gap: 8px;
            color: var(--info-color);
        }
        .optimization-suggestions h3 { color: var(--warning-color); }
        .optimization-suggestions h3 .fa-lightbulb { color: var(--warning-color); }

        .optimization-suggestions ul {
            list-style: none;
            padding-left: 0;
         }
         .optimization-suggestions li {
            margin-bottom: 0.7rem; /* More space */
            padding-left: 1.8rem;
            position: relative;
            font-size: 0.98rem;
            line-height: 1.5;
             opacity: 0;
             transform: translateX(-10px);
         }
         /* Custom bullet using FontAwesome check or info */
        .optimization-suggestions li::before {
             font-family: 'Font Awesome 6 Free';
             font-weight: 900;
             position: absolute;
             left: 0;
             top: 4px; /* Adjust alignment */
             width: 1em; /* Ensure spacing */
             text-align: center;
        }
         .optimization-suggestions li.suggestion-good::before {
            content: "\f058"; /* Check circle */
            color: var(--success-color);
         }
         .optimization-suggestions li.suggestion-info::before {
             content: "\f05a"; /* Info circle */
             color: var(--info-color);
         }
        .optimization-suggestions li strong { color: var(--primary-color); font-weight: 600;}
         .optimization-suggestions .placeholder-suggestion::before { content: "\f128"; /* Question Circle */ color: var(--secondary-color); }


        /* Charts */
        .charts-container {
            display: grid;
            /* Responsive grid */
             grid-template-columns: repeat(auto-fit, minmax(min(100%, 300px), 1fr)); /* Ensures charts don't get too wide on large screens */
            gap: 1.5rem;
            margin-top: 2.5rem;
             opacity: 0;
             transform: translateY(20px);
        }
        .chart-wrapper {
            background: var(--card-bg);
            padding: 1.2rem;
             border-radius: 8px;
             box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            position: relative;
             transition: all var(--transition-speed) ease;
            opacity: 0;
            transform: scale(0.9);
            min-height: 300px; /* Ensure charts have some height */
             display: flex;
            flex-direction: column;
        }
         .chart-wrapper h4 {
            text-align: center;
             margin-bottom: 1rem;
            font-weight: 500;
             font-size: 1rem;
            color: var(--secondary-color);
            transition: color var(--transition-speed) ease;
            flex-shrink: 0; /* Prevent header from shrinking */
         }
        .chart-wrapper canvas {
            max-width: 100%;
            height: auto !important;
             flex-grow: 1; /* Allow canvas to fill remaining space */
         }

        /* Download Button */
        .download-button-container {
            text-align: center;
             margin-top: 2.5rem;
             opacity: 0;
             transform: translateY(20px);
        }
        .btn-download {
            background-color: var(--success-color);
             color: white;
             border: none;
            padding: 0.9rem 2rem; /* Larger button */
             font-size: 1.1rem;
             font-weight: 600; /* Bold text */
            border-radius: 30px; /* Pill shape */
            cursor: pointer;
             transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            display: inline-flex;
             align-items: center;
             gap: 10px;
             box-shadow: 0 4px 12px rgba(var(--success-color-rgb), 0.3);
             text-decoration: none; /* Remove underline if used as <a> */
         }
        .btn-download:hover:not(:disabled) {
             background-color: #218838; /* Darker success */
             .dark-mode & { background-color: #1a9850; } /* Dark mode darker */
            transform: translateY(-3px);
             box-shadow: 0 7px 15px rgba(var(--success-color-rgb), 0.4);
         }
        .btn-download:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 3px 8px rgba(var(--success-color-rgb), 0.3);
        }
        .btn-download:disabled {
             background-color: var(--secondary-color);
            cursor: not-allowed;
             opacity: 0.6;
             box-shadow: none;
             transform: none;
        }
         .btn-download .fa-spinner {
             animation: fa-spin 1.5s linear infinite;
         }
         @keyframes fa-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
         }

        /* Footer */
        footer {
             text-align: center;
             margin-top: 4rem; /* More space */
            padding: 1.5rem 0;
            font-size: 0.9rem;
             color: var(--secondary-color);
            border-top: 1px solid var(--border-color);
            transition: color var(--transition-speed) ease, border-color var(--transition-speed) ease;
            opacity: 0;
             transform: translateY(20px);
        }
        footer p { margin-bottom: 0.5rem; }
        footer a {
            color: var(--primary-color);
            text-decoration: none;
             font-weight: 500;
             transition: color var(--transition-speed) ease;
         }
         footer a:hover {
             text-decoration: underline;
             color: #0056b3; /* Slightly darker blue on hover */
            .dark-mode & { color: #69b7f7; } /* Lighter blue */
        }
        footer .fa-heart { color: var(--error-color); }
        .disclaimer {
            font-size: 0.85rem;
             margin-top: 0.8rem;
             font-style: italic;
            max-width: 700px;
             margin-left: auto;
             margin-right: auto;
         }

        /* Responsiveness Adjustments */
        @media (max-width: 991px) { /* Adjust breakpoint where grid switches */
             .main-grid {
                 grid-template-columns: 1fr; /* Stack columns earlier */
            }
             .container {
                 width: 95%;
            }
            header h1 {
                font-size: clamp(1.4rem, 5vw, 1.8rem);
            }
        }

         @media (max-width: 768px) {
            html { font-size: 15px; }
             header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
             }
             .theme-switch-wrapper {
                 align-self: flex-end; /* Align toggle right */
            }
             .results-summary {
                 grid-template-columns: 1fr; /* Stack summary items earlier */
            }
            .breakdown-table th, .breakdown-table td {
                padding: 0.7rem 0.4rem;
                 font-size: 0.92rem;
            }
            .summary-item span {
                font-size: clamp(1.2rem, 4vw, 1.5rem);
            }
            .btn-download {
                 font-size: 1rem;
                 padding: 0.8rem 1.6rem;
             }
         }

         @media (max-width: 480px) {
             html { font-size: 14px; } /* Reduce base further */
            .container {
                padding: 1rem 0.8rem; /* Less horizontal padding */
            }
             header h1 {
                 font-size: clamp(1.2rem, 6vw, 1.5rem);
            }
            .card { padding: clamp(0.8rem, 4vw, 1.2rem); }
             .form-group input, .form-group select {
                 padding: 0.7rem 0.9rem;
             }
             .regime-toggle label {
                font-size: 0.9rem;
                 padding: 0.6rem 1rem;
             }
             .charts-container {
                 gap: 1rem;
            }
             .chart-wrapper { padding: 1rem; min-height: 250px; }
            .breakdown-table th { width: 60%; } /* Adjust width */
             footer { margin-top: 3rem; font-size: 0.85rem; }
         }

        /* Accessibility: Focus styles */
         a:focus-visible, button:focus-visible, input:focus-visible, select:focus-visible, [tabindex]:focus-visible {
             outline: 3px solid var(--primary-color);
             outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(var(--primary-color-rgb), 0.3);
            border-radius: 4px; /* Ensure focus outline matches shape */
        }
         /* Specific focus for custom elements */
         .theme-switch input:focus-visible + .slider {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(var(--primary-color-rgb), 0.3);
         }


        /* Reduced Motion Preferences */
        @media (prefers-reduced-motion: reduce) {
             *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                 scroll-behavior: auto !important;
                 /* Force GSAP to minimal/no animation */
                 /* GSAP usually respects this, but setting duration low helps */
             }
             .regime-slider { transition: none !important; } /* Disable specific transitions */
            .result-value { transition: none !important; }
        }

        /* Utility Classes */
         .hidden { display: none !important; } /* Use important to override inline styles if needed */
        .visually-hidden { /* Better than sr-only for modern accessibility */
            position: absolute !important;
            height: 1px; width: 1px;
             overflow: hidden;
             clip: rect(1px, 1px, 1px, 1px);
             white-space: nowrap; /* added line */
         }
         .text-center { text-align: center; }
         .mt-1 { margin-top: 0.5rem; }
         .mt-2 { margin-top: 1rem; }
         .mb-1 { margin-bottom: 0.5rem; }
         .mb-2 { margin-bottom: 1rem; }
         .mt-3 { margin-top: 1.5rem; }
         .mb-3 { margin-bottom: 1.5rem; }

    </style>
</head>
<body>

    <div class="container">
        <header id="main-header">
            <h1>
                <i class="fas fa-calculator"></i> Pro Indian Tax Calculator
                <small>(AY 2024-25)</small>
            </h1>
            <div class="theme-switch-wrapper">
                <span id="theme-label" aria-hidden="true">Light Mode</span>
                <label class="theme-switch" for="theme-toggle-checkbox">
                    <input type="checkbox" id="theme-toggle-checkbox" class="visually-hidden" aria-label="Toggle theme">
                    <div class="slider"></div>
                </label>
            </div>
        </header>

        <main class="main-grid">
            <!-- Input Section Column -->
            <section class="card" id="input-card">
                <h2><i class="fas fa-edit"></i> Enter Your Financial Details</h2>

                <form id="tax-form" novalidate> {/* Prevent default browser validation */}
                    <!-- Regime Selection -->
                    <div class="form-group regime-toggle-wrapper">
                        <label class="text-center mb-1" id="regime-label">Choose Tax Regime:</label>
                        <div class="regime-toggle" role="radiogroup" aria-labelledby="regime-label">
                             {/* New is first, visually matches left */}
                            <input type="radio" id="regime-new" name="taxRegime" value="new" checked>
                            <input type="radio" id="regime-old" name="taxRegime" value="old">

                            <label for="regime-new" id="label-regime-new">New Regime (Default)</label>
                            <label for="regime-old" id="label-regime-old">Old Regime</label>
                            <div class="regime-slider" aria-hidden="true"></div>
                        </div>
                    </div>

                     <!-- Income Details -->
                    <div class="form-group income-group" id="fg-gross-salary">
                         <label for="gross-salary">
                            Gross Salary Income
                            <i class="fas fa-info-circle" data-tooltip="Total salary before any deductions like PF, Prof. Tax etc. Required."></i>
                         </label>
                         <input type="number" id="gross-salary" placeholder="e.g., 1200000" min="0" step="1000" required aria-required="true">
                         <div class="error-message" id="gross-salary-error" role="alert"></div>
                    </div>

                     <div class="form-group income-group" id="fg-other-income">
                        <label for="other-income">
                            Income from Other Sources
                            <i class="fas fa-info-circle" data-tooltip="e.g., Interest, Dividends, Rental income (net of std deduction), Capital Gains etc. Enter 0 if none."></i>
                         </label>
                         <input type="number" id="other-income" placeholder="e.g., 50000" min="0" step="1000" value="0">
                        <div class="error-message" id="other-income-error" role="alert"></div>
                    </div>

                    <!-- Deductions Section (Initially hidden structure, shown based on regime) -->
                     <div id="deductions-wrapper"> {/* Wrapper for animation */}
                        <div id="deductions-section">
                             <h3>
                                <i class="fas fa-wallet"></i> Deductions & Exemptions
                                <span id="deduction-regime-note"></span>
                            </h3>

                             {/* HRA Claim Option (Always visible, but effect depends on Old Regime) */}
                             <div class="form-group deduction-group" id="fg-hra">
                                <label for="claim-hra">
                                    Claim HRA Exemption?
                                     <i class="fas fa-info-circle" data-tooltip="HRA Exemption is available ONLY under the Old Regime."></i>
                                 </label>
                                 <select id="claim-hra" disabled> {/* Initially disabled, enabled by JS if Old Regime */ }
                                    <option value="no" selected>No</option>
                                    <option value="yes">Yes (Requires Old Regime)</option>
                                </select>
                             </div>

                            <!-- HRA Detailed Inputs (Conditionally visible) -->
                            <div class="hra-inputs" id="hra-details">
                                 <p>HRA Details (Annual Figures):</p>
                                 <div class="form-group" id="fg-basic-salary-hra">
                                    <label for="basic-salary-hra">Basic Salary (for HRA calc)
                                         <i class="fas fa-info-circle" data-tooltip="Usually Basic + DA. Check your salary structure. Required if claiming HRA."></i>
                                    </label>
                                    <input type="number" id="basic-salary-hra" placeholder="e.g., 600000" min="0" step="1000" required>
                                    <div class="error-message" id="basic-salary-hra-error" role="alert"></div>
                                 </div>
                                 <div class="form-group" id="fg-hra-received">
                                     <label for="hra-received">HRA Received
                                         <i class="fas fa-info-circle" data-tooltip="Total HRA component in your salary. Required if claiming HRA."></i>
                                     </label>
                                    <input type="number" id="hra-received" placeholder="e.g., 240000" min="0" step="1000" required>
                                    <div class="error-message" id="hra-received-error" role="alert"></div>
                                 </div>
                                 <div class="form-group" id="fg-rent-paid">
                                     <label for="rent-paid">Total Rent Paid
                                        <i class="fas fa-info-circle" data-tooltip="Required if claiming HRA."></i>
                                    </label>
                                    <input type="number" id="rent-paid" placeholder="e.g., 300000" min="0" step="1000" required>
                                    <div class="error-message" id="rent-paid-error" role="alert"></div>
                                 </div>
                                <div class="form-group" id="fg-metro-city">
                                    <label for="metro-city">Living in Metro City?</label>
                                    <select id="metro-city">
                                        <option value="yes">Yes (Mumbai, Delhi, Chennai, Kolkata)</option>
                                        <option value="no" selected>No</option>
                                    </select>
                                 </div>
                            </div>

                             {/* Other Deductions (Only applicable in Old Regime) */}
                            <div class="form-group deduction-group" id="fg-80c">
                                <label for="deduction-80c">Section 80C
                                    <i class="fas fa-info-circle" data-tooltip="EPF, PPF, ELSS, Life Ins. Premium, Home Loan Principal, etc. Max: ‚Çπ1,50,000 (Old Regime Only)"></i>
                                </label>
                                <input type="number" id="deduction-80c" placeholder="Max 1,50,000" min="0" max="150000" step="1000" value="0" disabled>
                                <div class="error-message" id="deduction-80c-error" role="alert"></div>
                            </div>

                             <div class="form-group deduction-group" id="fg-80d">
                                <label for="deduction-80d">Section 80D (Health Insurance)
                                    <i class="fas fa-info-circle" data-tooltip="Self/Family (max ‚Çπ25k or ‚Çπ50k if senior citizen) + Parents (additional max ‚Çπ25k or ‚Çπ50k if senior). Enter total eligible. (Old Regime Only)"></i>
                                </label>
                                <input type="number" id="deduction-80d" placeholder="Max depends on age" min="0" step="500" value="0" disabled>
                                 <div class="error-message" id="deduction-80d-error" role="alert"></div>
                             </div>

                            <div class="form-group deduction-group" id="fg-80e">
                                <label for="deduction-80e">Section 80E (Edu Loan Interest)
                                     <i class="fas fa-info-circle" data-tooltip="Interest paid on loan for higher education. No max limit on interest amount. (Old Regime Only)"></i>
                                </label>
                                <input type="number" id="deduction-80e" placeholder="Enter total interest paid" min="0" step="1000" value="0" disabled>
                                <div class="error-message" id="deduction-80e-error" role="alert"></div>
                            </div>

                            <div class="form-group deduction-group" id="fg-nps-80ccd1b">
                                 <label for="deduction-nps-80ccd1b">Sec 80CCD(1B) (NPS Self)
                                     <i class="fas fa-info-circle" data-tooltip="Additional deduction for NPS self-contribution. Max: ‚Çπ50,000 (Old Regime Only)"></i>
                                 </label>
                                 <input type="number" id="deduction-nps-80ccd1b" placeholder="Max 50,000" min="0" max="50000" step="1000" value="0" disabled>
                                 <div class="error-message" id="deduction-nps-80ccd1b-error" role="alert"></div>
                            </div>

                            {/* Standard Deduction Note (Now applicable to both, just display info) */}
                            <div class="form-group deduction-info" id="fg-std-deduction-info">
                                 <p style="font-size: 0.9rem; color: var(--secondary-color); padding: 0.5rem; background: var(--highlight-bg); border-radius: 4px;">
                                    <i class="fas fa-info-circle"></i> A Standard Deduction of ‚Çπ50,000 is available under <strong>both</strong> Old and New Regimes (if Salary Income exists). It's automatically applied.
                                 </p>
                             </div>

                        </div>
                    </div>
                 </form>
            </section>

            <!-- Results Section Column -->
             <section class="card" id="results-section">
                 <h2><i class="fas fa-chart-line"></i> Tax Calculation Summary</h2>

                {/* Placeholder message initially */}
                 <div id="initial-message" class="text-center mt-2">
                     <p>Enter your income details in the form on the left to calculate your tax.</p>
                 </div>

                {/* Actual results container (hidden initially) */}
                 <div id="results-output" class="hidden"> {/* Start hidden */}

                    {/* Key Summary Figures */}
                     <div class="results-summary" id="res-summary-wrapper">
                         <div class="summary-item taxable-income-item" id="res-taxable-income">
                             <p>Net Taxable Income</p>
                            <span class="result-value" data-value="0">‚Çπ 0</span>
                         </div>
                        <div class="summary-item tax-payable-item" id="res-total-tax">
                             <p>Total Tax Payable</p>
                             <span class="result-value" data-value="0">‚Çπ 0</span>
                        </div>
                         <div class="summary-item take-home-item" id="res-net-income">
                            <p>Net Annual Pay (Post Tax)</p>
                            <span class="result-value" data-value="0">‚Çπ 0</span>
                        </div>
                         <div class="summary-item take-home-item" id="res-net-income-monthly">
                            <p>Net Monthly Pay (Post Tax)</p>
                             <span class="result-value" data-value="0">‚Çπ 0</span>
                         </div>
                    </div>

                    {/* Comparison Note (Dynamically generated) */}
                    <div class="comparison-note" id="comparison-note" style="display: none;">
                         {/* Content generated by JS */}
                    </div>


                    {/* Detailed Annual Breakdown Table */}
                    <div class="breakdown-container">
                        <h3><i class="fas fa-list-ul"></i> Annual Breakdown</h3>
                        <table class="breakdown-table" id="res-breakdown-table">
                            <tbody>
                                <tr id="row-gross-income"><th>Gross Total Income</th><td data-value="0">‚Çπ 0</td></tr>
                                 <tr id="row-std-deduction"><th>(-) Standard Deduction</th><td data-value="0">‚Çπ 0</td></tr>
                                <tr id="row-hra-deduction"><th>(-) HRA Exemption</th><td data-value="0">‚Çπ 0</td></tr>
                                <tr id="row-80c-deduction"><th>(-) Section 80C</th><td data-value="0">‚Çπ 0</td></tr>
                                <tr id="row-80d-deduction"><th>(-) Section 80D</th><td data-value="0">‚Çπ 0</td></tr>
                                <tr id="row-80e-deduction"><th>(-) Section 80E</th><td data-value="0">‚Çπ 0</td></tr>
                                <tr id="row-nps-deduction"><th>(-) Sec 80CCD(1B)</th><td data-value="0">‚Çπ 0</td></tr>
                                 <tr id="row-total-deductions" class="highlight-row"><th>Total Deductions & Exemptions</th><td data-value="0">‚Çπ 0</td></tr>
                                 <tr id="row-net-taxable-income" class="highlight-row"><th>(=) Net Taxable Income</th><td data-value="0">‚Çπ 0</td></tr>
                                <tr id="row-income-tax"><th>Income Tax</th><td data-value="0">‚Çπ 0</td></tr>
                                <tr id="row-rebate"><th>(-) Rebate u/s 87A</th><td data-value="0">(-) ‚Çπ 0</td></tr>
                                 <tr id="row-tax-after-rebate"><th>Tax After Rebate</th><td data-value="0">‚Çπ 0</td></tr>
                                <tr id="row-cess"><th>(+) Health & Edu Cess (4%)</th><td data-value="0">‚Çπ 0</td></tr>
                                <tr id="row-total-tax-payable" class="highlight-row total-tax-row"><th>(=) Total Tax Payable</th><td data-value="0">‚Çπ 0</td></tr>
                            </tbody>
                        </table>
                     </div>

                     {/* Tax Optimization Suggestions */}
                     <div class="optimization-suggestions" id="optimization-suggestions">
                        <h3><i class="fas fa-lightbulb"></i> Tax Optimization Suggestions</h3>
                        <ul id="suggestions-list">
                            <li class="placeholder-suggestion">Suggestions will appear here after calculation.</li>
                         </ul>
                    </div>

                    {/* Charts Area */}
                     <div class="charts-container" id="chart-area">
                        <div class="chart-wrapper" id="wrapper-comparison-chart">
                            <h4><i class="fas fa-balance-scale-right"></i> Old vs New Regime Tax</h4>
                            <canvas id="comparisonChart" role="img" aria-label="Bar chart comparing tax in Old vs New regime"></canvas>
                         </div>
                         <div class="chart-wrapper" id="wrapper-income-breakdown-chart">
                             <h4><i class="fas fa-chart-pie"></i> Income Breakdown (Annual)</h4>
                            <canvas id="incomeBreakdownChart" role="img" aria-label="Doughnut chart showing income split: Take-Home, Tax, Deductions"></canvas>
                        </div>
                        <div class="chart-wrapper" id="wrapper-tax-components-chart">
                             <h4><i class="fas fa-percentage"></i> Tax Components</h4>
                            <canvas id="taxComponentsChart" role="img" aria-label="Pie chart showing tax components: Base Tax and Cess"></canvas>
                        </div>
                     </div>

                     {/* Download PDF Button */}
                     <div class="download-button-container">
                         <button id="download-pdf" class="btn-download" disabled>
                             <i class="fas fa-file-pdf"></i> Download PDF Report
                        </button>
                     </div>

                </div> {/* End #results-output */}
             </section>
        </main>

        <footer>
            <p>Built with <i class="fas fa-heart"></i> for educational purposes. Hosted on GitHub Pages.</p>
            <p class="disclaimer">
                <strong>Disclaimer:</strong> This calculator provides estimates based on AY 2024-25 (FY 2023-24) rules and the data entered. It does not account for all possible income sources, deductions, or complexities (like surcharge for high income, agricultural income, capital gains details etc.). Tax laws can change. Always consult with a qualified tax professional for personalized financial advice.
            </p>
             <p>
                <a href="https://github.com/YOUR_USERNAME/YOUR_REPO_NAME" target="_blank" rel="noopener noreferrer"> {/* <-- IMPORTANT: Update this link */}
                     <i class="fab fa-github"></i> View Source on GitHub
                 </a>
             </p>
             <p>&copy; <span id="current-year"></span> Your Name / Project Name {/* <-- Update */} . All Rights Reserved.</p>
        </footer>
    </div>

    <script>
        /* ========================== */
        /* == JavaScript Logic       == */
        /* ========================== */
        document.addEventListener('DOMContentLoaded', () => {

            // --- Global Constants & State ---
            const CURRENT_AY = "2024-25";
            const CURRENT_FY = "2023-24";
            const STD_DEDUCTION_AMOUNT = 50000;
             const NEW_REGIME_REBATE_LIMIT = 700000;
            const OLD_REGIME_REBATE_LIMIT = 500000;
            const OLD_REGIME_REBATE_MAX_AMOUNT = 12500;
            const MAX_80C_LIMIT = 150000;
            const MAX_80CCD1B_LIMIT = 50000;
            const CESS_RATE = 0.04;

            let taxData = {}; // Stores final calculated results for UI/PDF
             let charts = {}; // Stores Chart.js instances
            let isDarkMode = false;
            let calculationTimeout; // For debouncing input

             // --- Utility Functions ---
            const qs = (selector) => document.querySelector(selector);
            const qsa = (selector) => document.querySelectorAll(selector);
            const formatCurrency = (value, hideZero = false) => {
                 if (hideZero && value === 0) return "‚Çπ -";
                 const roundedValue = Math.round(value);
                 if (roundedValue < 0) {
                    return `(-) ‚Çπ ${Math.abs(roundedValue).toLocaleString('en-IN')}`;
                 }
                 return `‚Çπ ${roundedValue.toLocaleString('en-IN')}`;
             };

            // --- DOM Element References ---
            const form = qs('#tax-form');
            const grossSalaryInput = qs('#gross-salary');
             const otherIncomeInput = qs('#other-income');
            const regimeNewRadio = qs('#regime-new');
            const regimeOldRadio = qs('#regime-old');
            const claimHraSelect = qs('#claim-hra');
            const hraDetailsDiv = qs('#hra-details');
            const basicSalaryHraInput = qs('#basic-salary-hra');
            const hraReceivedInput = qs('#hra-received');
            const rentPaidInput = qs('#rent-paid');
             const metroCitySelect = qs('#metro-city');
            const deduction80CInput = qs('#deduction-80c');
             const deduction80DInput = qs('#deduction-80d');
             const deduction80EInput = qs('#deduction-80e');
             const deductionNpsInput = qs('#deduction-nps-80ccd1b');
             const deductionsSection = qs('#deductions-section');
            const deductionsWrapper = qs('#deductions-wrapper');
            const deductionInputs = qsa('#deductions-section .deduction-group input, #deductions-section .deduction-group select'); // More specific selector
             const deductionRegimeNote = qs('#deduction-regime-note');
             const resultsOutput = qs('#results-output');
            const initialMessage = qs('#initial-message');
            const downloadPdfButton = qs('#download-pdf');
            const suggestionsList = qs('#suggestions-list');
            const comparisonNoteDiv = qs('#comparison-note');

            // Result Display Elements
            const resTaxableIncomeSpan = qs('#res-taxable-income .result-value');
             const resTotalTaxSpan = qs('#res-total-tax .result-value');
             const resNetIncomeSpan = qs('#res-net-income .result-value');
             const resNetIncomeMonthlySpan = qs('#res-net-income-monthly .result-value');
             // Table Data Cells
             const tableCells = {
                grossIncome: qs('#row-gross-income td'),
                stdDeduction: qs('#row-std-deduction td'),
                hraDeduction: qs('#row-hra-deduction td'),
                c80cDeduction: qs('#row-80c-deduction td'),
                 c80dDeduction: qs('#row-80d-deduction td'),
                 c80eDeduction: qs('#row-80e-deduction td'),
                npsDeduction: qs('#row-nps-deduction td'),
                totalDeductions: qs('#row-total-deductions td'),
                 netTaxableIncome: qs('#row-net-taxable-income td'),
                incomeTax: qs('#row-income-tax td'),
                rebate: qs('#row-rebate td'),
                taxAfterRebate: qs('#row-tax-after-rebate td'),
                cess: qs('#row-cess td'),
                totalTaxPayable: qs('#row-total-tax-payable td')
             };

             // Chart Canvases
             const comparisonChartCtx = qs('#comparisonChart').getContext('2d');
             const incomeBreakdownChartCtx = qs('#incomeBreakdownChart').getContext('2d');
             const taxComponentsChartCtx = qs('#taxComponentsChart').getContext('2d');

             // Theme Toggle Elements
             const themeToggle = qs('#theme-toggle-checkbox');
             const themeLabel = qs('#theme-label');
             const body = document.body;
             const htmlEl = document.documentElement;

            // --- Theme Handling ---
             const applyTheme = (theme, isInitial = false) => {
                 isDarkMode = theme === 'dark';
                 htmlEl.classList.toggle('dark-mode', isDarkMode); // Apply class to HTML for global var access
                themeLabel.textContent = isDarkMode ? 'Dark Mode' : 'Light Mode';
                 themeToggle.checked = isDarkMode;
                localStorage.setItem('theme', theme);

                 // Update Chart themes (defer if initial load, charts might not exist yet)
                 if (!isInitial && Object.keys(charts).length > 0) {
                    updateChartThemes();
                 }
             };

             const toggleTheme = () => {
                const newTheme = isDarkMode ? 'light' : 'dark';
                // GSAP cross-fade (or just instant change for simplicity)
                gsap.to("body", { // Target body for visual background transition
                     backgroundColor: `var(--bg-color-${newTheme})`, // Access the specific theme variable
                    duration: 0.1, // Quick fade
                     onComplete: () => { // Apply class and logic AFTER visual change starts
                         applyTheme(newTheme);
                    }
                 });
                // Animate slider handle quickly
                gsap.fromTo(themeToggle.nextElementSibling.querySelector('.slider:before'),
                    { scale: 1 },
                    { scale: 1.15, yoyo: true, repeat: 1, duration: 0.2, ease: 'power2.inOut' }
                );
            };

             // Load theme on start
             const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
             applyTheme(savedTheme, true); // Apply instantly on load

             themeToggle.addEventListener('change', toggleTheme);


            // --- Input Validation & Error Handling ---
            const showError = (inputId, message) => {
                const inputElement = qs(`#${inputId}`);
                 const errorElement = qs(`#${inputId}-error`);
                 if (!inputElement || !errorElement) return; // Element might not exist/be relevant

                inputElement.classList.add('error-input');
                inputElement.setAttribute('aria-invalid', 'true');
                inputElement.setAttribute('aria-describedby', `${inputId}-error`);

                gsap.killTweensOf(inputElement); // Stop any previous animation
                 gsap.fromTo(inputElement, { x: 0 }, { x: "-=3", duration: 0.06, repeat: 5, yoyo: true, ease: "power1.inOut", clearProps: "x" }); // Shake [Anim 1]
                errorElement.textContent = message;
                errorElement.classList.add('visible');
                 gsap.fromTo(errorElement, { opacity: 0, y: -5 }, { opacity: 1, y: 0, duration: 0.3, ease: "power1.out" }); // Fade in error [Anim 2]

                disableDownloadButton(); // Ensure download is disabled on error
             };

             const clearError = (inputId) => {
                 const inputElement = qs(`#${inputId}`);
                 const errorElement = qs(`#${inputId}-error`);
                 if (!inputElement || !errorElement) return;

                inputElement.classList.remove('error-input');
                inputElement.setAttribute('aria-invalid', 'false');
                inputElement.removeAttribute('aria-describedby');
                 // Animation fade out error [Anim 4]
                 gsap.to(errorElement, {
                     opacity: 0, duration: 0.2, ease: "power1.in", onComplete: () => {
                        errorElement.textContent = '';
                         errorElement.classList.remove('visible');
                     }
                 });
             };

            const clearAllErrors = () => {
                qsa('.error-message').forEach(el => {
                    const inputId = el.id.replace('-error', '');
                    clearError(inputId);
                });
            };

             const validateNumberInput = (inputId, fieldName, isRequired, maxLimit = Infinity, minLimit = 0) => {
                 const input = qs(`#${inputId}`);
                const valueStr = input.value.trim();
                let value = NaN;

                clearError(inputId); // Clear previous error first

                 // Check required field
                 if (isRequired && valueStr === '') {
                    showError(inputId, `${fieldName} is required.`);
                     return { isValid: false, value: NaN };
                }
                 // Allow non-required empty fields (treat as 0 later)
                 if (!isRequired && valueStr === '') {
                     return { isValid: true, value: 0 };
                }

                value = parseFloat(valueStr);

                 // Check if valid number
                if (isNaN(value)) {
                    showError(inputId, `Invalid number for ${fieldName}.`);
                    return { isValid: false, value: NaN };
                 }
                 // Check min limit
                 if (value < minLimit) {
                     showError(inputId, `${fieldName} cannot be negative.`);
                     return { isValid: false, value: value };
                 }
                 // Check max limit
                 if (value > maxLimit) {
                    showError(inputId, `${fieldName} cannot exceed ${formatCurrency(maxLimit)}.`);
                    return { isValid: false, value: value };
                 }

                // Valid input
                 return { isValid: true, value: value };
             };


            const validateForm = () => {
                 clearAllErrors(); // Start fresh
                 let isFormValid = true;
                let inputValues = {}; // Store validated values

                 // Gross Salary (Required)
                 const salaryValidation = validateNumberInput('gross-salary', 'Gross Salary', true);
                 if (!salaryValidation.isValid) isFormValid = false;
                 inputValues.grossSalary = salaryValidation.value;

                 // Other Income (Not required, default 0)
                 const otherIncomeValidation = validateNumberInput('other-income', 'Other Income', false);
                 if (!otherIncomeValidation.isValid) isFormValid = false;
                 inputValues.otherIncome = otherIncomeValidation.value;

                // Deductions - Validate only if Old Regime is selected and inputs are enabled
                 inputValues.claimHRA = claimHraSelect.value;
                 inputValues.isMetro = metroCitySelect.value;
                const isOldRegimeSelected = regimeOldRadio.checked;

                 if (isOldRegimeSelected) {
                    // HRA Details (Required only if Claim HRA is 'yes')
                    if (inputValues.claimHRA === 'yes') {
                         const hraBasicValidation = validateNumberInput('basic-salary-hra', 'Basic Salary for HRA', true);
                         const hraReceivedValidation = validateNumberInput('hra-received', 'HRA Received', true);
                         const hraRentPaidValidation = validateNumberInput('rent-paid', 'Rent Paid', true);

                         if (!hraBasicValidation.isValid || !hraReceivedValidation.isValid || !hraRentPaidValidation.isValid) isFormValid = false;
                         inputValues.basicSalaryHRA = hraBasicValidation.value;
                        inputValues.hraReceived = hraReceivedValidation.value;
                        inputValues.rentPaid = hraRentPaidValidation.value;
                    } else {
                         // Set to 0 if not claiming
                        inputValues.basicSalaryHRA = 0;
                        inputValues.hraReceived = 0;
                         inputValues.rentPaid = 0;
                    }

                     // 80C
                     const c80cValidation = validateNumberInput('deduction-80c', 'Section 80C', false, MAX_80C_LIMIT);
                     if (!c80cValidation.isValid) isFormValid = false;
                    inputValues.deduction80C = c80cValidation.value;

                     // 80D (No fixed max here, just validate number)
                     const c80dValidation = validateNumberInput('deduction-80d', 'Section 80D', false);
                     if (!c80dValidation.isValid) isFormValid = false;
                     inputValues.deduction80D = c80dValidation.value;

                    // 80E (No max)
                    const c80eValidation = validateNumberInput('deduction-80e', 'Section 80E', false);
                     if (!c80eValidation.isValid) isFormValid = false;
                     inputValues.deduction80E = c80eValidation.value;

                     // 80CCD(1B) NPS
                    const npsValidation = validateNumberInput('deduction-nps-80ccd1b', 'Section 80CCD(1B)', false, MAX_80CCD1B_LIMIT);
                    if (!npsValidation.isValid) isFormValid = false;
                    inputValues.deductionNps = npsValidation.value;

                } else {
                     // Set all old regime deductions to 0 if new regime selected
                     inputValues.basicSalaryHRA = 0;
                     inputValues.hraReceived = 0;
                     inputValues.rentPaid = 0;
                     inputValues.deduction80C = 0;
                     inputValues.deduction80D = 0;
                    inputValues.deduction80E = 0;
                     inputValues.deductionNps = 0;
                 }

                 // Enable/disable download button based on validation
                 if (isFormValid) {
                     enableDownloadButton();
                 } else {
                     disableDownloadButton();
                     hideResults(); // Hide results if form becomes invalid
                 }

                 return { isValid: isFormValid, values: inputValues };
             };

             // --- HRA Calculation ---
            const calculateHraExemption = (basic, hraReceived, rentPaid, isMetro) => {
                // Assume inputs are already validated numbers
                if (basic <= 0 || rentPaid <= 0 || hraReceived <= 0) {
                    return 0; // No exemption if any essential component is missing or zero
                 }

                const rentOver10pctBasic = Math.max(0, rentPaid - (0.10 * basic));
                 const hraLimitPct = isMetro ? 0.50 : 0.40;
                 const salaryLimit = hraLimitPct * basic;

                 return Math.min(hraReceived, rentOver10pctBasic, salaryLimit);
             };

            // --- Manage Deductions UI Based on Regime ---
            const updateDeductionsUI = (isOldRegime) => {
                // Animate the wrapper visibility/height for smoother effect
                gsap.to(deductionsSection, {
                     opacity: isOldRegime ? 1 : 0.6, // Slightly visible but greyed out in New? Or fully hidden? Let's try opacity.
                    duration: 0.4
                });

                deductionInputs.forEach(input => {
                    const isDisabled = !isOldRegime;
                    const formGroup = input.closest('.form-group');

                    if (isDisabled && input.id === 'claim-hra') {
                         input.disabled = true; // Keep HRA claim dropdown technically enabled but maybe reset it?
                         input.value = 'no'; // Reset HRA claim if switching to New
                    } else if (input.id !== 'claim-hra') {
                        input.disabled = isDisabled;
                     }

                     if (isDisabled) {
                        // Optionally reset non-HRA fields when disabled
                        if (input.tagName !== 'SELECT' && input.id !== 'claim-hra') {
                           input.value = '0';
                        }
                         clearError(input.id); // Clear errors from disabled fields
                         gsap.to(formGroup, { opacity: 0.5, duration: 0.3 }); // Fade disabled groups [Anim]
                    } else {
                         gsap.to(formGroup, { opacity: 1, duration: 0.3 }); // Fade in enabled groups [Anim]
                     }
                });
                // Also specifically enable/disable the main HRA dropdown itself based on Old Regime
                 claimHraSelect.disabled = !isOldRegime;

                 deductionRegimeNote.textContent = isOldRegime ? '(Deductions below applicable)' : '(Most deductions below N/A)';

                toggleHraDetailsVisibility(); // Ensure HRA details show/hide correctly
             };


            // --- Toggle HRA Details Input Section Visibility ---
             const toggleHraDetailsVisibility = () => {
                 const shouldShow = regimeOldRadio.checked && claimHraSelect.value === 'yes';
                if (shouldShow) {
                    if (!hraDetailsDiv.classList.contains('visible')) {
                        hraDetailsDiv.classList.add('visible');
                         gsap.to(hraDetailsDiv, { maxHeight: '600px', opacity: 1, marginTop: '1rem', padding: '1rem 0 0.5rem 1.2rem', duration: 0.5, ease: 'power2.out' }); // Anim Expand HRA [Anim 5]
                         // Stagger input reveals [Anim 6, 7, 8, 9]
                        gsap.fromTo(hraDetailsDiv.querySelectorAll('.form-group'), { opacity: 0, x: -10 }, { opacity: 1, x: 0, duration: 0.3, stagger: 0.1, delay: 0.2 });
                     }
                } else {
                     if (hraDetailsDiv.classList.contains('visible')) {
                        gsap.to(hraDetailsDiv, { // Anim Collapse HRA [Anim 10]
                             maxHeight: 0, opacity: 0, marginTop: 0, padding: '0 0 0 1.2rem', duration: 0.4, ease: 'power2.in', onComplete: () => {
                                 hraDetailsDiv.classList.remove('visible');
                                // Reset HRA input values and errors when hiding
                                 [basicSalaryHraInput, hraReceivedInput, rentPaidInput].forEach(input => {
                                    input.value = '';
                                    clearError(input.id);
                                });
                             }
                         });
                    }
                 }
            };


            // --- Core Tax Calculation Logic ---
            const calculateTax = (taxableIncome, regime) => {
                 let tax = 0;
                 let rebate = 0;
                let effectiveRebateLimit = 0;

                 if (regime === 'old') {
                    // Old Regime Slabs (Assuming age < 60)
                    if (taxableIncome <= 250000) { tax = 0; }
                    else if (taxableIncome <= 500000) { tax = (taxableIncome - 250000) * 0.05; }
                     else if (taxableIncome <= 1000000) { tax = 12500 + (taxableIncome - 500000) * 0.20; }
                     else { tax = 112500 + (taxableIncome - 1000000) * 0.30; }

                    // Rebate u/s 87A for Old Regime
                     effectiveRebateLimit = OLD_REGIME_REBATE_LIMIT;
                     if (taxableIncome <= effectiveRebateLimit) {
                         rebate = Math.min(tax, OLD_REGIME_REBATE_MAX_AMOUNT);
                    }
                 } else { // New Regime (Default - AY 2024-25)
                    if (taxableIncome <= 300000) { tax = 0; }
                    else if (taxableIncome <= 600000) { tax = (taxableIncome - 300000) * 0.05; }
                     else if (taxableIncome <= 900000) { tax = 15000 + (taxableIncome - 600000) * 0.10; }
                     else if (taxableIncome <= 1200000) { tax = 45000 + (taxableIncome - 900000) * 0.15; }
                    else if (taxableIncome <= 1500000) { tax = 90000 + (taxableIncome - 1200000) * 0.20; }
                    else { tax = 150000 + (taxableIncome - 1500000) * 0.30; }

                    // Rebate u/s 87A for New Regime (AY 2024-25 specific)
                    effectiveRebateLimit = NEW_REGIME_REBATE_LIMIT;
                     if (taxableIncome <= effectiveRebateLimit) {
                         // Full tax liability is rebated if taxable income is up to 7Lakhs.
                         rebate = tax;
                     }
                 }

                 const taxAfterRebate = Math.max(0, tax - rebate);
                const cessAmount = Math.round(taxAfterRebate * CESS_RATE); // Calculate cess on tax after rebate, round it
                const totalTax = taxAfterRebate + cessAmount;

                 return {
                     incomeTax: tax,
                     rebate: rebate,
                     taxAfterRebate: taxAfterRebate,
                     cess: cessAmount,
                    totalTaxPayable: totalTax,
                     effectiveRebateLimit: effectiveRebateLimit // Useful for suggestions
                };
             };

             // --- Main Calculation Trigger Function ---
            const runCalculation = () => {
                const validationResult = validateForm();
                if (!validationResult.isValid) {
                     // Errors shown by validateForm, ensure results are hidden
                    hideResults();
                     return;
                 }

                 const inputs = validationResult.values;
                 const selectedRegime = regimeNewRadio.checked ? 'new' : 'old';

                 // Calculate Gross Total Income
                 const grossTotalIncome = inputs.grossSalary + inputs.otherIncome;

                 // Determine Deductions based on selected regime
                let standardDeduction = 0;
                 let hraExemption = 0;
                let deduction80C = 0;
                 let deduction80D = 0;
                let deduction80E = 0;
                let deductionNps = 0;
                let totalDeductions = 0;

                 // Standard deduction applies to both if salary exists
                 if (inputs.grossSalary > 0) {
                    standardDeduction = STD_DEDUCTION_AMOUNT;
                }

                if (selectedRegime === 'old') {
                     // Calculate HRA if claimed (inputs are validated)
                     if (inputs.claimHRA === 'yes') {
                         hraExemption = calculateHraExemption(
                             inputs.basicSalaryHRA,
                             inputs.hraReceived,
                             inputs.rentPaid,
                             inputs.isMetro === 'yes'
                         );
                     }
                    // Use validated & capped deduction values
                     deduction80C = inputs.deduction80C; // Already capped by validateNumberInput
                     deduction80D = inputs.deduction80D;
                    deduction80E = inputs.deduction80E;
                     deductionNps = inputs.deductionNps; // Already capped

                     totalDeductions = standardDeduction + hraExemption + deduction80C + deduction80D + deduction80E + deductionNps;
                 } else {
                     // New Regime only allows Standard Deduction (from FY 23-24 / AY 24-25)
                     totalDeductions = standardDeduction;
                    // Ensure other deductions are zero for consistency in data
                     hraExemption = 0;
                     deduction80C = 0;
                    deduction80D = 0;
                     deduction80E = 0;
                     deductionNps = 0;
                 }

                // Calculate Net Taxable Income
                const netTaxableIncome = Math.max(0, grossTotalIncome - totalDeductions);

                // Calculate Tax based on taxable income and regime
                 const currentRegimeTaxResults = calculateTax(netTaxableIncome, selectedRegime);

                // Prepare `taxData` object for UI, charts, PDF
                taxData = {
                    ...currentRegimeTaxResults, // Includes incomeTax, rebate, taxAfterRebate, cess, totalTaxPayable
                     selectedRegime: selectedRegime,
                     grossTotalIncome: grossTotalIncome,
                    grossSalary: inputs.grossSalary, // Store for later checks
                     otherIncome: inputs.otherIncome, // Store for potential later use
                     standardDeduction: standardDeduction,
                     hraExemption: hraExemption,
                     deduction80C: deduction80C,
                     deduction80D: deduction80D,
                    deduction80E: deduction80E,
                     deductionNps: deductionNps,
                     totalDeductions: totalDeductions,
                     netTaxableIncome: netTaxableIncome,
                     netAnnualIncome: grossTotalIncome - currentRegimeTaxResults.totalTaxPayable,
                    netMonthlyIncome: (grossTotalIncome - currentRegimeTaxResults.totalTaxPayable) / 12,
                     // Store raw inputs for potential recalculation (e.g., for comparison regime)
                     rawInputs: inputs
                };

                // Calculate tax under the *other* regime for comparison chart/note
                const otherRegime = selectedRegime === 'old' ? 'new' : 'old';
                let otherRegimeNetTaxable = 0;
                 if (otherRegime === 'old') {
                     // Simulate deductions under old regime using potentially entered values
                    let potentialOldStdDed = (inputs.grossSalary > 0) ? STD_DEDUCTION_AMOUNT : 0;
                    let potentialHRA = 0;
                    if(inputs.claimHRA === 'yes' && inputs.basicSalaryHRA && inputs.hraReceived && inputs.rentPaid) { // Only calc if attempt made
                         potentialHRA = calculateHraExemption(inputs.basicSalaryHRA, inputs.hraReceived, inputs.rentPaid, inputs.isMetro === 'yes');
                     }
                     let potentialOldDeductions = potentialOldStdDed + potentialHRA + inputs.deduction80C + inputs.deduction80D + inputs.deduction80E + inputs.deductionNps;
                     otherRegimeNetTaxable = Math.max(0, grossTotalIncome - potentialOldDeductions);
                 } else { // other regime is 'new'
                    let potentialNewStdDed = (inputs.grossSalary > 0) ? STD_DEDUCTION_AMOUNT : 0;
                    otherRegimeNetTaxable = Math.max(0, grossTotalIncome - potentialNewStdDed);
                 }
                 taxData.otherRegimeTaxData = calculateTax(otherRegimeNetTaxable, otherRegime);
                taxData.otherRegime = otherRegime;

                // Update UI with results
                 showResults(); // Animates results into view
                 updateUIValues(); // Updates numbers and table
                updateCharts(); // Updates graphs
                generateSuggestions(); // Generates helpful tips
                 generateComparisonNote(); // Generates comparison text

            };

             // --- Update UI Elements with Calculated Data ---
            const showResults = () => {
                if (resultsOutput.classList.contains('hidden')) {
                    resultsOutput.classList.remove('hidden');
                    initialMessage.classList.add('hidden');
                    // GSAP Animation: Reveal results section [Anim 13]
                    gsap.fromTo(resultsOutput,
                        { opacity: 0, y: 20 },
                        { opacity: 1, y: 0, height: 'auto', duration: 0.5, ease: 'power2.out', delay: 0.1 }
                     );
                     gsap.to(initialMessage, { opacity: 0, duration: 0.2 }); // Hide initial msg

                    // Stagger reveal of summary items [Anim 14, 15, 16, 17]
                     gsap.fromTo(".results-summary .summary-item",
                         { opacity: 0, scale: 0.9 },
                         { opacity: 1, scale: 1, duration: 0.4, stagger: 0.1, ease: "back.out(1.7)", delay: 0.3 }
                    );
                     // Stagger reveal table rows [Anim 18 variations x 14 rows = ~14 anims]
                    gsap.fromTo("#res-breakdown-table tbody tr",
                        { opacity: 0, x: -20 },
                        { opacity: 1, x: 0, duration: 0.3, stagger: 0.05, ease: "power1.out", delay: 0.5 }
                    );
                    // Animate reveal sections below table
                    gsap.fromTo("#optimization-suggestions, #chart-area, #download-pdf",
                        { opacity: 0, y: 15 },
                         { opacity: 1, y: 0, duration: 0.5, stagger: 0.15, ease: "power2.out", delay: 0.8 }
                    );
                 }
            };

             const hideResults = () => {
                 if (!resultsOutput.classList.contains('hidden')) {
                     // Anim Hide Results [Anim 11]
                     gsap.to(resultsOutput, {
                         opacity: 0, y: 20, duration: 0.4, ease: "power2.in", onComplete: () => {
                            resultsOutput.classList.add('hidden');
                             initialMessage.classList.remove('hidden');
                             gsap.fromTo(initialMessage, { opacity: 0 }, { opacity: 1, duration: 0.3 }); // Anim Show Initial [Anim 12]
                            clearCharts();
                            clearSuggestions();
                             comparisonNoteDiv.style.display = 'none';
                             disableDownloadButton();
                        }
                     });
                 }
             };


             const updateUIValues = () => {
                 // Counter animation function using GSAP
                const animateCounter = (element, value) => {
                     // Read the current value from attribute if needed for smoother start, otherwise start from current display
                    let startValue = parseFloat(element.getAttribute('data-value')) || 0; // Read previous final value
                     gsap.to(element, {
                         duration: 1.0, // Slightly longer for smoother effect
                        textContent: Math.round(value), // Target the final rounded value
                        ease: "power2.out",
                         snap: { textContent: 1 }, // Snap to integers during animation
                         onUpdate: function() {
                            // Format currency on each frame update
                            this.targets()[0].textContent = formatCurrency(parseFloat(this.targets()[0].textContent));
                        },
                        onComplete: function() {
                             // Ensure final display is perfectly formatted
                            this.targets()[0].textContent = formatCurrency(value);
                             this.targets()[0].setAttribute('data-value', value); // Store final value
                        }
                     });
                };

                 // Animate Summary Spans [Anim 19, 20, 21, 22]
                animateCounter(resTaxableIncomeSpan, taxData.netTaxableIncome);
                animateCounter(resTotalTaxSpan, taxData.totalTaxPayable);
                 animateCounter(resNetIncomeSpan, taxData.netAnnualIncome);
                 animateCounter(resNetIncomeMonthlySpan, taxData.netMonthlyIncome);

                 // Update Breakdown Table (using direct update for simplicity now)
                const updateCell = (cellElement, value, isNegative = false, hideZero = true) => {
                    if(!cellElement) return; // Guard against null elements
                     const formattedValue = formatCurrency(value, hideZero);
                     cellElement.textContent = isNegative ? `(-) ${formattedValue.replace('‚Çπ ','')}` : formattedValue;
                     cellElement.setAttribute('data-value', Math.round(value));
                     // Optional simple fade for cell update [Anim 23 implied]
                    gsap.fromTo(cellElement, { opacity: 0.7 }, { opacity: 1, duration: 0.3 });
                 };

                 updateCell(tableCells.grossIncome, taxData.grossTotalIncome, false, false); // Don't hide zero GTI
                updateCell(tableCells.stdDeduction, taxData.standardDeduction);
                 updateCell(tableCells.hraDeduction, taxData.hraExemption);
                updateCell(tableCells.c80cDeduction, taxData.deduction80C);
                 updateCell(tableCells.c80dDeduction, taxData.deduction80D);
                updateCell(tableCells.c80eDeduction, taxData.deduction80E);
                 updateCell(tableCells.npsDeduction, taxData.deductionNps);
                updateCell(tableCells.totalDeductions, taxData.totalDeductions);
                updateCell(tableCells.netTaxableIncome, taxData.netTaxableIncome, false, false);
                 updateCell(tableCells.incomeTax, taxData.incomeTax);
                 updateCell(tableCells.rebate, taxData.rebate, true); // Show as negative
                updateCell(tableCells.taxAfterRebate, taxData.taxAfterRebate);
                 updateCell(tableCells.cess, taxData.cess);
                updateCell(tableCells.totalTaxPayable, taxData.totalTaxPayable, false, false); // Final tax, show zero if it is
             };


            // --- Chart.js Integration ---
            const initializeCharts = () => {
                const defaultChartOptions = (titleText = '') => ({
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                        legend: {
                            position: 'bottom',
                             labels: { padding: 15, usePointStyle: true, font: { family: 'Poppins', size: 11 } }
                         },
                        title: { display: !!titleText, text: titleText, padding: { top: 5, bottom: 10 }, font: { size: 14, family: 'Poppins' } },
                         tooltip: {
                             backgroundColor: isDarkMode ? 'rgba(50,50,50,0.9)' : 'rgba(255,255,255,0.9)',
                             titleColor: isDarkMode ? '#eee' : '#333',
                            bodyColor: isDarkMode ? '#ddd' : '#555',
                            borderColor: isDarkMode ? '#666' : '#ddd',
                            borderWidth: 1,
                             padding: 10,
                            boxPadding: 4,
                            bodyFont: { family: 'Poppins' },
                             titleFont: { family: 'Poppins', weight: 'bold' },
                             callbacks: {
                                 label: (context) => {
                                     let label = context.dataset.label || context.label || '';
                                    if (label) label += ': ';
                                    const value = context.parsed.y ?? context.parsed; // Handle bar, pie, doughnut
                                     if (value !== null && typeof value !== 'undefined') {
                                        label += formatCurrency(value);
                                     }
                                     return label;
                                }
                             }
                         }
                    },
                     animation: { duration: 800, easing: 'easeOutQuart' }, // Anim Chart draw [implied]
                 });

                const barChartOptions = defaultChartOptions();
                 barChartOptions.scales = {
                     y: { beginAtZero: true, ticks: { font: { family: 'Poppins' }, callback: value => formatCurrency(value, true) }, grid: { } }, // Dynamic color set in updateTheme
                    x: { ticks: { font: { family: 'Poppins' } }, grid: { display: false } } // Dynamic color set in updateTheme
                 };

                 const doughnutPieOptions = defaultChartOptions();
                 doughnutPieOptions.plugins.legend.position = 'right'; // Position legend differently

                charts.comparison = new Chart(comparisonChartCtx, { type: 'bar', data: { labels: [], datasets: [] }, options: barChartOptions });
                charts.incomeBreakdown = new Chart(incomeBreakdownChartCtx, { type: 'doughnut', data: { labels: [], datasets: [] }, options: { ...doughnutPieOptions, cutout: '65%' } });
                 charts.taxComponents = new Chart(taxComponentsChartCtx, { type: 'pie', data: { labels: [], datasets: [] }, options: doughnutPieOptions });

                // Set initial theme colors
                updateChartThemes();
            };

             const updateChartThemes = () => {
                if (Object.keys(charts).length === 0) return; // Exit if no charts

                const textColor = isDarkMode ? '#e0e0e0' : '#333';
                const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                 const secondaryColor = isDarkMode ? 'rgba(255, 255, 255, 0.6)' : 'rgba(0, 0, 0, 0.5)';
                const tooltipBg = isDarkMode ? 'rgba(40,40,40,0.9)' : 'rgba(255,255,255,0.95)';
                const tooltipBorder = isDarkMode ? '#777' : '#ccc';

                 Object.values(charts).forEach(chart => {
                     // Update Scales (if they exist)
                     if (chart.options.scales?.y) {
                        chart.options.scales.y.ticks.color = secondaryColor;
                        chart.options.scales.y.grid.color = gridColor;
                    }
                     if (chart.options.scales?.x) {
                         chart.options.scales.x.ticks.color = secondaryColor;
                         chart.options.scales.x.grid.color = gridColor;
                     }
                     // Update Legend
                    chart.options.plugins.legend.labels.color = textColor;
                    // Update Tooltips
                    chart.options.plugins.tooltip.backgroundColor = tooltipBg;
                    chart.options.plugins.tooltip.titleColor = textColor;
                     chart.options.plugins.tooltip.bodyColor = textColor;
                     chart.options.plugins.tooltip.borderColor = tooltipBorder;

                    // Redraw chart with new colors (without data animation)
                    chart.update('none');
                 });
             };


            const updateCharts = () => {
                 if (!taxData || !taxData.grossTotalIncome || Object.keys(charts).length === 0) {
                    clearCharts(); return;
                 }

                // Get current and other regime tax amounts
                const currentTax = taxData.totalTaxPayable;
                const otherTax = taxData.otherRegimeTaxData.totalTaxPayable;
                 const currentLabel = taxData.selectedRegime === 'old' ? 'Old Regime' : 'New Regime';
                 const otherLabel = taxData.otherRegime === 'old' ? 'Old Regime' : 'New Regime';

                // --- Comparison Chart (Bar) ---
                 const barLabels = [currentLabel, otherLabel];
                const barData = [currentTax, otherTax];
                 const comparisonBg = isDarkMode
                     ? ['rgba(255, 193, 7, 0.7)', 'rgba(13, 202, 240, 0.7)'] // Dark: Gold, Cyan
                    : ['rgba(255, 193, 7, 0.8)', 'rgba(13, 202, 240, 0.8)']; // Light: Gold, Cyan
                const comparisonBorder = isDarkMode
                    ? ['#ffc107', '#0dcaf0']
                     : ['#e0a800', '#0bacbf'];

                 if (taxData.selectedRegime === 'new') { // Ensure consistent bar order (New left, Old right)
                    barLabels.reverse();
                     barData.reverse();
                    comparisonBg.reverse();
                     comparisonBorder.reverse();
                 }

                charts.comparison.data.labels = barLabels;
                charts.comparison.data.datasets = [{
                     label: 'Total Tax',
                     data: barData,
                    backgroundColor: comparisonBg,
                    borderColor: comparisonBorder,
                     borderWidth: 1.5,
                    borderRadius: 4,
                }];
                 charts.comparison.update();
                 gsap.from(charts.comparison.canvas, { duration: 0.5, scaleY: 0.8, opacity: 0.5, ease: 'back.out(1.5)', delay: 0.1 }); // Anim Chart Update [Anim 26]


                // --- Income Breakdown Chart (Doughnut) ---
                 const takeHome = Math.max(0, taxData.netAnnualIncome);
                 const totalTaxBreakdown = taxData.totalTaxPayable;
                const deductions = taxData.totalDeductions;
                 // Avoid tiny slices if possible
                 const breakdownData = [];
                 const breakdownLabels = [];
                 const breakdownColors = [];
                if (takeHome > 0) { breakdownData.push(takeHome); breakdownLabels.push('Net Take-Home'); breakdownColors.push(isDarkMode ? '#20c997' : '#28a745'); } // Success
                if (totalTaxBreakdown > 0) { breakdownData.push(totalTaxBreakdown); breakdownLabels.push('Total Tax'); breakdownColors.push(isDarkMode ? '#f76e79' : '#dc3545'); } // Error
                 if (deductions > 0) { breakdownData.push(deductions); breakdownLabels.push('Deductions/Exemptions'); breakdownColors.push(isDarkMode ? '#adb5bd' : '#6c757d'); } // Secondary

                charts.incomeBreakdown.data.labels = breakdownLabels;
                 charts.incomeBreakdown.data.datasets = [{
                    data: breakdownData,
                    backgroundColor: breakdownColors,
                    borderColor: isDarkMode ? '#2c2c2c' : '#ffffff', // Match card bg for border effect
                    borderWidth: 2,
                    hoverOffset: 8
                }];
                 charts.incomeBreakdown.update();
                 gsap.from(charts.incomeBreakdown.canvas, { duration: 0.7, rotation: -90, opacity: 0.5, ease: 'power2.out', delay: 0.15 }); // Anim Chart Update [Anim 27]


                 // --- Tax Components Chart (Pie) ---
                const baseTax = taxData.taxAfterRebate;
                 const cess = taxData.cess;
                 const componentsWrapper = qs('#wrapper-tax-components-chart');

                if (taxData.totalTaxPayable > 0) { // Only show if there's tax
                     componentsWrapper.style.display = ''; // Remove display:none if it was set
                     const pieData = [];
                    const pieLabels = [];
                    const pieColors = [];
                    if(baseTax > 0) { pieData.push(baseTax); pieLabels.push('Tax Before Cess'); pieColors.push(isDarkMode ? '#fd7e14' : '#fd7e14'); } // Orange
                     if(cess > 0) { pieData.push(cess); pieLabels.push('Health & Edu Cess'); pieColors.push(isDarkMode ? '#6c757d' : '#6c757d'); } // Grey

                     charts.taxComponents.data.labels = pieLabels;
                     charts.taxComponents.data.datasets = [{
                         data: pieData,
                         backgroundColor: pieColors,
                        borderColor: isDarkMode ? '#2c2c2c' : '#ffffff',
                        borderWidth: 2,
                        hoverOffset: 6
                    }];
                     charts.taxComponents.update();
                     // Ensure wrapper is visible and animate chart [Anim 28]
                     gsap.to(componentsWrapper, { opacity: 1, scale: 1, duration: 0.5, ease: 'back.out(1.2)' });
                     gsap.from(charts.taxComponents.canvas, { duration: 0.6, scale: 0.8, opacity: 0.5, ease: 'expo.out', delay: 0.2 });
                } else {
                     // Hide chart smoothly if tax is zero
                    gsap.to(componentsWrapper, { // Anim Hide Chart [Implied variation]
                         opacity: 0, scale: 0.9, duration: 0.4, onComplete: () => {
                             componentsWrapper.style.display = 'none'; // Hide wrapper after anim
                             charts.taxComponents.data.labels = [];
                             charts.taxComponents.data.datasets = [];
                             charts.taxComponents.update();
                         }
                     });
                }

                 // Anim Charts container reveal (already included in showResults()) [Anim 29]
             };


            const clearCharts = () => {
                 Object.values(charts).forEach(chart => {
                    chart.data.labels = [];
                     chart.data.datasets = [];
                     chart.update('none'); // Update without animation
                 });
                 // Optional: hide wrappers smoothly
                 qsa('.chart-wrapper').forEach(wrapper => {
                     gsap.to(wrapper, { opacity: 0, scale: 0.9, duration: 0.3 }); // Anim Hide Chart wrappers [Anim 30 implied]
                });
            };

            // --- Tax Optimization Suggestions ---
             const generateSuggestions = () => {
                suggestionsList.innerHTML = ''; // Clear previous
                 let suggestionsAdded = 0;
                if (!taxData || !taxData.grossTotalIncome || !validateForm().isValid) {
                    suggestionsList.innerHTML = '<li class="placeholder-suggestion">Enter valid details to get suggestions.</li>';
                     return;
                }

                 const addSuggestion = (text, type = 'info') => { // Types: 'info', 'good'
                    const li = document.createElement('li');
                    li.innerHTML = text;
                    li.classList.add(type === 'good' ? 'suggestion-good' : 'suggestion-info');
                    suggestionsList.appendChild(li);
                    suggestionsAdded++;
                    // Anim suggestion fade-in [Anim 31 - repeated]
                     gsap.fromTo(li, { opacity: 0, x: -15 }, { opacity: 1, x: 0, duration: 0.4, ease: "power1.out", delay: suggestionsAdded * 0.1 });
                };

                 const currentTax = taxData.totalTaxPayable;
                const otherTax = taxData.otherRegimeTaxData.totalTaxPayable;
                const currentRegime = taxData.selectedRegime;
                const otherRegime = taxData.otherRegime;
                const rawInputs = taxData.rawInputs; // Use validated inputs stored earlier


                 // 1. Regime Comparison Suggestion
                 if (Math.abs(currentTax - otherTax) < 500) { // Threshold for "similar" tax
                     addSuggestion(`Tax under both ${currentRegime === 'old' ? 'Old' : 'New'} and ${otherRegime === 'old' ? 'Old' : 'New'} Regimes is very similar (${formatCurrency(currentTax)} vs ${formatCurrency(otherTax)}). Consider flexibility.`, 'info');
                 } else if (currentTax < otherTax) {
                    addSuggestion(`The selected <strong>${currentRegime === 'old' ? 'Old' : 'New'} Regime</strong> seems beneficial, saving ~<strong>${formatCurrency(otherTax - currentTax)}</strong> compared to the ${otherRegime === 'old' ? 'Old' : 'New'} Regime.`, 'good');
                 } else {
                     addSuggestion(`Consider the <strong>${otherRegime === 'old' ? 'Old' : 'New'} Regime</strong>. It could potentially save you ~<strong>${formatCurrency(currentTax - otherTax)}</strong> in taxes based on current inputs.`, 'info');
                }


                // 2. Old Regime Deduction Suggestions (Only show if Old Regime is selected OR potentially better)
                 if (currentRegime === 'old' || otherTax > currentTax && otherRegime === 'old') {
                    // 80C Suggestion
                     if (taxData.deduction80C < MAX_80C_LIMIT) {
                         const remaining80C = MAX_80C_LIMIT - taxData.deduction80C;
                        addSuggestion(`Maximize <strong>Section 80C</strong> benefit under Old Regime. You can potentially claim ${formatCurrency(remaining80C)} more (up to ‚Çπ1.5 Lakh total) via EPF, PPF, ELSS, Term Life Premium, etc.`, 'info');
                     } else {
                         addSuggestion(`You've fully utilized the ‚Çπ1.5 Lakh limit under Section 80C (Old Regime).`, 'good');
                     }

                     // 80CCD(1B) NPS Suggestion
                     if (taxData.deductionNps < MAX_80CCD1B_LIMIT) {
                        const remainingNps = MAX_80CCD1B_LIMIT - taxData.deductionNps;
                         addSuggestion(`Utilize the additional ‚Çπ50k deduction via <strong>Section 80CCD(1B)</strong> by investing ${formatCurrency(remainingNps)} more in NPS (Tier 1) under the Old Regime.`, 'info');
                     }

                    // 80D Suggestion
                     if (taxData.deduction80D === 0) {
                        addSuggestion(`Explore tax savings on Health Insurance premiums via <strong>Section 80D</strong> (Old Regime). Limits depend on age (‚Çπ25k/‚Çπ50k).`, 'info');
                    }

                    // HRA Suggestion
                    if (taxData.hraExemption === 0 && rawInputs.claimHRA === 'no' && (rawInputs.rentPaid || 0) > 0) { // Check if rent was entered but HRA not claimed
                        addSuggestion(`If you pay rent and meet HRA conditions, claiming it under the <strong>Old Regime</strong> can reduce tax. Ensure HRA details are filled and 'Claim HRA' is 'Yes'.`, 'info');
                    } else if (taxData.hraExemption > 0) {
                        addSuggestion(`HRA exemption of ${formatCurrency(taxData.hraExemption)} applied under the Old Regime based on your inputs.`, 'good');
                     }
                 }


                 // 3. Standard Deduction Info (Always relevant if salary income exists)
                if (taxData.standardDeduction > 0) {
                     addSuggestion(`Standard Deduction of ${formatCurrency(taxData.standardDeduction)} is automatically applied as you have salary income. This benefit is available in both regimes.`, 'good');
                 }


                 // Fallback if no suggestions generated
                 if (suggestionsAdded === 0) {
                     addSuggestion("Calculation complete. Review breakdown and charts.", 'good');
                 }
                  // Anim Reveal Suggestion Box [Anim 32] - included in showResults() reveal sequence now
             };


            const clearSuggestions = () => {
                suggestionsList.innerHTML = '<li class="placeholder-suggestion">Suggestions will appear here.</li>';
                 gsap.to(qs('#optimization-suggestions'), { opacity: 0, duration: 0.2 }); // Anim Hide suggestions
            };


             // --- Comparison Note ---
             const generateComparisonNote = () => {
                 if (!taxData || typeof taxData.totalTaxPayable === 'undefined' || typeof taxData.otherRegimeTaxData === 'undefined') {
                     comparisonNoteDiv.style.display = 'none';
                     return;
                 }
                const currentTax = taxData.totalTaxPayable;
                const otherTax = taxData.otherRegimeTaxData.totalTaxPayable;
                const currentLabel = taxData.selectedRegime === 'old' ? 'Old Regime' : 'New Regime';
                const otherLabel = taxData.otherRegime === 'old' ? 'Old Regime' : 'New Regime';
                const difference = Math.abs(currentTax - otherTax);

                let noteHTML = '';
                 let iconClass = 'fa-info-circle';
                let colorVar = '--info-color';

                if (difference < 500) { // Close enough
                    iconClass = 'fa-balance-scale';
                    colorVar = '--secondary-color';
                    noteHTML = `Tax liability under both <strong>${currentLabel}</strong> (${formatCurrency(currentTax)}) and <strong>${otherLabel}</strong> (${formatCurrency(otherTax)}) is very similar.`;
                } else if (currentTax < otherTax) {
                    iconClass = 'fa-check-circle';
                     colorVar = '--success-color';
                     noteHTML = `The selected <strong>${currentLabel}</strong> (${formatCurrency(currentTax)}) appears more beneficial, saving approximately <strong>${formatCurrency(difference)}</strong> compared to the ${otherLabel} (${formatCurrency(otherTax)}).`;
                 } else { // currentTax > otherTax
                     iconClass = 'fa-exclamation-triangle';
                    colorVar = '--warning-color';
                     noteHTML = `Consider switching to the <strong>${otherLabel}</strong>. It could potentially lower your tax to ${formatCurrency(otherTax)}, saving approximately <strong>${formatCurrency(difference)}</strong> compared to the ${currentLabel} (${formatCurrency(currentTax)}).`;
                }

                 comparisonNoteDiv.innerHTML = `
                     <h3><i class="fas ${iconClass}" style="color: var(${colorVar});"></i> Regime Comparison</h3>
                     <p>${noteHTML}</p>`;
                 comparisonNoteDiv.style.borderColor = `var(${colorVar})`;
                comparisonNoteDiv.style.display = ''; // Ensure it's block/flex/whatever is default

                 // Anim Fade/Scale note [Anim 33] - included in showResults() reveal sequence now
                 gsap.fromTo(comparisonNoteDiv, { opacity: 0, scale: 0.95 }, { opacity: 1, scale: 1, duration: 0.5, ease: 'back.out(1.2)', delay: 0.1 });
             };

             // --- PDF Generation (jsPDF & jsPDF-AutoTable) ---
            const generatePDF = () => {
                if (!taxData || Object.keys(taxData).length === 0 || !validateForm().isValid) {
                     alert("Please ensure tax is calculated with valid inputs before generating the PDF.");
                    return;
                 }

                const originalButtonContent = downloadPdfButton.innerHTML;
                 downloadPdfButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                downloadPdfButton.disabled = true;
                gsap.to(downloadPdfButton, { opacity: 0.7, duration: 0.2 }); // Anim Button Busy [Anim 34]

                try {
                     // Use jsPDF from the global scope (loaded via CDN)
                     const { jsPDF } = window.jspdf;
                     const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

                     // --- PDF Styling and Helpers ---
                     let yPos = 15; // Top margin
                     const margin = 15;
                    const pageHeight = doc.internal.pageSize.height;
                     const pageWidth = doc.internal.pageSize.width;
                     const usableWidth = pageWidth - 2 * margin;

                    const addWrappedText = (text, x, y, maxWidth, options = {}) => {
                        const lines = doc.splitTextToSize(text, maxWidth);
                        doc.text(lines, x, y, options);
                         return y + (lines.length * (options.lineHeightFactor || 1.15) * (doc.getFontSize() / doc.internal.scaleFactor));
                    };

                     const addHeading = (text, y, level = 1) => {
                         const fontSize = level === 1 ? 16 : (level === 2 ? 14 : 12);
                         doc.setFontSize(fontSize);
                        doc.setFont(undefined, 'bold');
                         doc.setTextColor(40, 119, 171); // Primary color
                        yPos = y + (level === 1 ? 8 : 6); // Spacing before heading
                         doc.text(text, margin, yPos);
                        yPos += 5; // Spacing after heading
                        doc.setFont(undefined, 'normal'); // Reset font
                         doc.setTextColor(0); // Reset color
                        doc.setLineWidth(0.3);
                        doc.setDrawColor(200); // Light grey line
                        doc.line(margin, yPos, pageWidth - margin, yPos);
                         yPos += 5;
                        return yPos;
                     };

                    const addLineItem = (label, value, y) => {
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                         doc.setTextColor(80); // Grey for label
                         doc.text(label, margin, y);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(0); // Black for value
                         doc.text(value, margin + usableWidth / 2, y, { align: 'left' }); // Value aligned middle
                        return y + 6; // Line height
                     };


                    // --- PDF Content ---
                    doc.setFontSize(18); doc.setFont(undefined, 'bold'); doc.setTextColor(40, 119, 171);
                     doc.text(`Income Tax Report - AY ${CURRENT_AY}`, pageWidth / 2, yPos, { align: 'center' });
                     yPos += 6;
                    doc.setFontSize(9); doc.setFont(undefined, 'normal'); doc.setTextColor(120);
                     doc.text(`Generated on: ${new Date().toLocaleDateString()} | Regime: ${taxData.selectedRegime === 'old' ? 'Old' : 'New (Default)'}`, pageWidth / 2, yPos, { align: 'center' });
                     yPos += 8;

                    // -- Summary --
                    yPos = addHeading("Calculation Summary", yPos, 2);
                     yPos = addLineItem("Gross Total Income:", formatCurrency(taxData.grossTotalIncome), yPos);
                    yPos = addLineItem("Total Deductions:", formatCurrency(taxData.totalDeductions), yPos);
                    yPos = addLineItem("Net Taxable Income:", formatCurrency(taxData.netTaxableIncome), yPos);
                    yPos = addLineItem("Total Tax Payable:", formatCurrency(taxData.totalTaxPayable), yPos);
                     doc.setFont(undefined, 'bold'); doc.setTextColor(40, 167, 69); // Success color for take home
                    yPos = addLineItem("Net Annual Take-Home:", formatCurrency(taxData.netAnnualIncome), yPos);
                    yPos = addLineItem("Net Monthly Take-Home:", formatCurrency(taxData.netMonthlyIncome), yPos);
                    doc.setTextColor(0); // Reset color

                     // Check page break before table
                    if (yPos > pageHeight - 80) { doc.addPage(); yPos = margin; }

                    // -- Detailed Breakdown Table --
                     yPos = addHeading("Annual Breakdown", yPos, 2);

                     const tableHead = [['Component', 'Amount (‚Çπ)']];
                     const tableBody = [
                         ['Gross Total Income', formatCurrency(taxData.grossTotalIncome, false)], // Row 1
                        ['(-) Standard Deduction', formatCurrency(taxData.standardDeduction)], // Row 2
                        ['(-) HRA Exemption', formatCurrency(taxData.hraExemption)], // Row 3
                        ['(-) Section 80C', formatCurrency(taxData.deduction80C)], // Row 4
                         ['(-) Section 80D', formatCurrency(taxData.deduction80D)], // Row 5
                         ['(-) Section 80E', formatCurrency(taxData.deduction80E)], // Row 6
                        ['(-) Section 80CCD(1B) NPS', formatCurrency(taxData.deductionNps)], // Row 7
                         ['Total Deductions/Exemptions', formatCurrency(taxData.totalDeductions)], // Row 8 (Highlight)
                        ['(=) Net Taxable Income', formatCurrency(taxData.netTaxableIncome, false)], // Row 9 (Highlight)
                        ['Income Tax (Before Rebate)', formatCurrency(taxData.incomeTax)], // Row 10
                        ['(-) Rebate u/s 87A', `(-) ${formatCurrency(taxData.rebate).replace('‚Çπ ','')}`], // Row 11
                        ['Tax After Rebate', formatCurrency(taxData.taxAfterRebate)], // Row 12
                         ['(+) Health & Edu Cess (4%)', formatCurrency(taxData.cess)], // Row 13
                         ['(=) Total Tax Payable', formatCurrency(taxData.totalTaxPayable, false)], // Row 14 (Highlight)
                     ];

                     doc.autoTable({
                         head: tableHead,
                         body: tableBody,
                        startY: yPos,
                        theme: 'grid',
                         headStyles: { fillColor: [23, 162, 184], textColor: 255, fontStyle: 'bold', fontSize: 10 },
                        bodyStyles: { fontSize: 9, cellPadding: 2 },
                        columnStyles: { 1: { halign: 'right' } },
                        didParseCell: function(data) {
                             // Apply bold style to specific rows
                            if (data.section === 'body' && [7, 8, 13].includes(data.row.index)) { // Indices are 0-based: row 8, 9, 14
                                data.cell.styles.fontStyle = 'bold';
                            }
                            // Optionally apply background color highlights
                            if (data.section === 'body' && [7, 8, 13].includes(data.row.index)) {
                                data.cell.styles.fillColor = '#f0f0f0'; // Light grey
                             }
                         },
                         didDrawPage: function (data) {
                             yPos = data.cursor.y + 5; // Update yPos after table potentially adds pages
                         }
                     });

                     // Check for page break before suggestions
                    if (yPos > pageHeight - 50) { doc.addPage(); yPos = margin; }

                    // -- Suggestions --
                    const suggestionItems = suggestionsList.querySelectorAll('li:not(.placeholder-suggestion)');
                    if (suggestionItems.length > 0) {
                         yPos = addHeading("Tax Optimization Suggestions", yPos, 2);
                         doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                         doc.setTextColor(50);
                         suggestionItems.forEach(item => {
                             const prefix = item.classList.contains('suggestion-good') ? '‚úì ' : '‚Ä¢ ';
                            // Remove HTML tags before adding to PDF
                             const cleanText = item.innerHTML.replace(/<[^>]*>/g, ""); // Basic tag removal
                             yPos = addWrappedText(`${prefix}${cleanText}`, margin + 3, yPos + 3, usableWidth - 3, {lineHeightFactor: 1.3});
                             if (yPos > pageHeight - 25) { doc.addPage(); yPos = margin; } // Check space within loop
                         });
                     }

                    // --- Footer on each page ---
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.setFontSize(8);
                     doc.setTextColor(150);
                     for (let i = 1; i <= pageCount; i++) {
                         doc.setPage(i);
                         doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                         doc.text("Disclaimer: Estimated calculation. Consult a tax professional.", margin, pageHeight - 10);
                     }


                    // --- Save ---
                    doc.save(`Income_Tax_Report_AY${CURRENT_AY}_${new Date().toISOString().slice(0,10)}.pdf`);

                } catch (error) {
                     console.error("Error generating PDF:", error);
                     alert("An error occurred while generating the PDF report. Please check the console for details.");
                 } finally {
                    // Reset button state regardless of success/error
                     setTimeout(() => {
                         downloadPdfButton.innerHTML = originalButtonContent;
                         downloadPdfButton.disabled = !validateForm().isValid; // Re-enable only if form still valid
                        gsap.to(downloadPdfButton, { opacity: 1, duration: 0.2 }); // Anim Restore Button [Anim 35]
                     }, 500);
                }
             };


             const enableDownloadButton = () => {
                 if (!downloadPdfButton.disabled) return; // Already enabled
                downloadPdfButton.disabled = false;
                 gsap.to(downloadPdfButton, { opacity: 1, scale: 1, cursor: 'pointer', duration: 0.3, ease: 'power1.out' }); // Anim Enable Button [Anim 36]
             };

             const disableDownloadButton = () => {
                 if (downloadPdfButton.disabled) return; // Already disabled
                downloadPdfButton.disabled = true;
                 gsap.to(downloadPdfButton, { opacity: 0.6, scale: 0.98, cursor: 'not-allowed', duration: 0.3, ease: 'power1.out' }); // Anim Disable Button
            };


             // --- Event Listeners ---
             const handleInputChange = () => {
                 clearTimeout(calculationTimeout); // Debounce: Clear previous timeout
                calculationTimeout = setTimeout(runCalculation, 400); // Recalculate after 400ms pause
            };

             // Attach listeners to all relevant inputs
            qsa('#tax-form input[type="number"], #tax-form select').forEach(element => {
                 element.addEventListener('input', handleInputChange); // Use 'input' for immediate feedback on numbers
                 element.addEventListener('change', handleInputChange); // Use 'change' for selects/radios

                // Input Focus/Blur Animations [Anim 37, 38]
                 element.addEventListener('focus', (e) => {
                     if (!e.target.disabled) {
                         gsap.to(e.target.closest('.form-group'), { scale: 1.02, zIndex: 1, duration: 0.2 });
                    }
                 });
                 element.addEventListener('blur', (e) => {
                     gsap.to(e.target.closest('.form-group'), { scale: 1, zIndex: 0, duration: 0.3 });
                 });
             });

             // Regime radio buttons listener (triggers UI update and calculation immediately)
             qsa('input[name="taxRegime"]').forEach(radio => {
                 radio.addEventListener('change', () => {
                     const isOld = radio.value === 'old';
                    // Animate slider
                    const slider = qs('.regime-slider');
                    gsap.to(slider, { // Anim Regime Slider [Anim 39]
                        transform: `translateX(${isOld ? 'calc(100%)' : '0%'})`,
                         duration: 0.45,
                         ease: 'elastic.out(1, 0.75)'
                     });
                     updateDeductionsUI(isOld);
                    runCalculation(); // Recalculate immediately on regime change
                 });
             });

            // HRA claim select listener (triggers visibility toggle and calculation)
            claimHraSelect.addEventListener('change', () => {
                 toggleHraDetailsVisibility();
                 runCalculation(); // Recalculate if HRA claim status changes
             });


            downloadPdfButton.addEventListener('click', generatePDF);

             // --- Initial Setup Call ---
             const initializeApp = () => {
                 updateDeductionsUI(regimeOldRadio.checked); // Set initial UI based on default regime
                initializeCharts(); // Create chart instances
                disableDownloadButton(); // Button should start disabled
                qs('#current-year').textContent = new Date().getFullYear();

                 // Initial Page Load Animations [Anim 40-47]
                 const tl = gsap.timeline({ defaults: { ease: "power2.out" } });
                 tl.to("#main-header", { y: 0, opacity: 1, duration: 0.6 })
                    .to("#input-card", { scale: 1, opacity: 1, duration: 0.5 }, "-=0.3")
                    .to("#results-section", { scale: 1, opacity: 1, duration: 0.5 }, "-=0.4")
                    .to(".regime-toggle-wrapper", { y: 0, opacity: 1, duration: 0.4 }, "-=0.3")
                    .to(".income-group", { x: 0, opacity: 1, duration: 0.4, stagger: 0.1 }, "-=0.2")
                     // Stagger deduction input groups (initial state depends on regime)
                     .to(".form-group.deduction-group, .form-group.deduction-info", { x: 0, opacity: (el) => el.querySelector(':disabled') ? 0.5 : 1, duration: 0.3, stagger: 0.05 }, "-=0.2")
                     .to("footer", { y: 0, opacity: 1, duration: 0.6 }, "+=0.2");

                 // Trigger a calculation if there are default values that make the form initially valid
                 // Run initial validation (which might trigger calc if valid)
                 // validateForm(); Commented out: Let user interaction trigger first calc typically
             };

            initializeApp(); // Run setup

        }); // End DOMContentLoaded
    </script>

</body>
</html>